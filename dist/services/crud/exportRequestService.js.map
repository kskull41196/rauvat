{"version":3,"sources":["../../../build/services/crud/exportRequestService.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","crudService_pg_1","require","tables_1","services_1","const_1","ExportRequestService","ExportRequest","params","option","request_array","items","rows","count_request","length","i","exec","model","findOne","where","id","export_request_id","allowNull","item","state","error","amount","employee_id","employee_feedback","User","user_id","userItem","Wallet","walletItem","amount_of_purchase","registrationToken","registation_id","message","firebaseService","sendNotification","FCM_ACTIONS","WALLET","wallet_id","address","WalletExport","create","applyCreateOptions","createExport","parseInt","update","updateWallet","fullname","updated_export_wallet","dataValues","push","count","CrudService"],"mappings":"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","file":"exportRequestService.js","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst crudService_pg_1 = require(\"../crudService.pg\");\nconst tables_1 = require(\"@/models/tables\");\nconst services_1 = require(\"@/services\");\nconst const_1 = require(\"../../const\");\nclass ExportRequestService extends crudService_pg_1.CrudService {\n    constructor() {\n        super(tables_1.ExportRequest);\n    }\n    execute(params, option) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const request_array = params.items;\n            let rows = [];\n            const count_request = request_array.length;\n            for (let i = 0; i < count_request; i++) {\n                const item = yield this.exec(this.model.findOne({ where: { id: request_array[i].export_request_id } }), { allowNull: false });\n                let state;\n                let error;\n                const amount = item.amount;\n                const employee_id = params.employee_id;\n                const employee_feedback = \"\";\n                let userItem = yield this.exec(tables_1.User.findOne({ where: { id: item.user_id } }), { allowNull: false }); //tìm user\n                const walletItem = yield this.exec(tables_1.Wallet.findOne({ where: { user_id: item.user_id } }), { allowNull: false }); //tìm ví của user trên\n                if (walletItem.amount_of_purchase < amount) {\n                    params.state = \"DENIED\";\n                    state = params.state;\n                    error = \"Tài Khoản Không Đủ Tiền Rút\";\n                    const registrationToken = userItem.registation_id;\n                    var message = error;\n                    services_1.firebaseService.sendNotification(registrationToken, message, const_1.FCM_ACTIONS.WALLET);\n                }\n                else {\n                    const wallet_id = walletItem.id;\n                    const address = userItem.address;\n                    const createExport = yield this.exec(tables_1.WalletExport.create({ wallet_id, amount, employee_id, address }, this.applyCreateOptions(option)));\n                    params.amount_of_purchase = parseInt(walletItem.amount_of_purchase) - parseInt(amount);\n                    const amount_of_purchase = params.amount_of_purchase;\n                    var updateWallet = yield this.exec(walletItem.update({ amount_of_purchase }));\n                    params.state = \"EXPORTED\";\n                    state = params.state;\n                    const registrationToken = userItem.registation_id;\n                    var message = userItem.fullname + \", bạn đã rút \" + item.amount + \" khỏi ví của mình.\";\n                    services_1.firebaseService.sendNotification(registrationToken, message, const_1.FCM_ACTIONS.WALLET);\n                }\n                // } else {\n                //     throw errorService.database.queryFail(\"Yêu cầu Đã Được Xử Lý\")\n                // }\n                var updated_export_wallet = yield this.exec(item.update({ state, employee_id, employee_feedback }));\n                updated_export_wallet.dataValues['error'] = error;\n                rows.push({ updated_export_wallet, updateWallet });\n            }\n            return { count: count_request, rows: rows };\n        });\n    }\n}\nexports.ExportRequestService = ExportRequestService;\n//# sourceMappingURL=exportRequestService.js.map"]}